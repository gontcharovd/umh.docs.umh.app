---
title: "Upgrade to v0.13.4"
content_type: upgrading
description: "This page describes how to upgrade the United Manufacturing Hub
to version 0.13.4"
weight: -00013003
---

This page describes how to upgrade the United Manufacturing Hub to version 0.13.4.
Before upgrading, remember to backup the
[database](/docs/production-guide/backup_recovery/backup-timescale/),
[Node-RED flows](/docs/production-guide/backup_recovery/import-export-node-red/),
and your cluster configuration.

## Update Helm Repo

Fetch the latest Helm charts from the UMH repository:

```bash
sudo $(which helm) repo update --kubeconfig /etc/rancher/k3s/k3s.yaml
```


## Upgrade Helm Chart

Upgrade the Helm chart to the 0.13.4 version:
```bash
sudo $(which helm) upgrade united-manufacturing-hub united-manufacturing-hub/united-manufacturing-hub -n united-manufacturing-hub --version 0.13.4 --reuse-values --kubeconfig /etc/rancher/k3s/k3s.yaml \
--set mqtt_broker.initContainer.hivemqextensioninit.image.tag=0.11.0
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -c "CREATE USER kafkatopostgresqlv2;" || true
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -c "CREATE DATABASE umh_v2 OWNER kafkatopostgresqlv2;" || true
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE umh_v2 TO kafkatopostgresqlv2;"
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -c "CREATE USER grafanareader;" || true
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -c "GRANT USAGE ON SCHEMA public TO grafanareader;"
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO kafkatopostgresqlv2;"
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO kafkatopostgresqlv2;"
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE TABLE IF NOT EXISTS asset (
id SERIAL PRIMARY KEY,
enterprise TEXT NOT NULL,
site TEXT DEFAULT '' NOT NULL,
area TEXT DEFAULT '' NOT NULL,
line TEXT DEFAULT '' NOT NULL,
workcell TEXT DEFAULT '' NOT NULL,
origin_id TEXT DEFAULT '' NOT NULL,
UNIQUE (enterprise, site, area, line, workcell, origin_id)
);
-- These are just to drop for old installs.
ALTER TABLE asset DROP CONSTRAINT IF EXISTS asset_enterprise_key;
ALTER TABLE asset DROP CONSTRAINT IF EXISTS asset_enterprise_site_key;
ALTER TABLE asset DROP CONSTRAINT IF EXISTS asset_enterprise_site_area_key;
ALTER TABLE asset DROP CONSTRAINT IF EXISTS asset_enterprise_site_area_line_key;
ALTER TABLE asset DROP CONSTRAINT IF EXISTS asset_enterprise_site_area_line_workcell_key;
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE TABLE IF NOT EXISTS tag (
timestamp TIMESTAMPTZ NOT NULL,
name TEXT NOT NULL,
origin TEXT NOT NULL,
asset_id INT REFERENCES asset(id) NOT NULL,
value REAL,
UNIQUE (name, asset_id, timestamp)
);
SELECT create_hypertable('tag', 'timestamp', if_not_exists => TRUE);;
CREATE INDEX IF NOT EXISTS ON tag (asset_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS ON tag (name);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE TABLE IF NOT EXISTS tag_string (
timestamp TIMESTAMPTZ NOT NULL,
name TEXT NOT NULL,
origin TEXT NOT NULL,
asset_id INT REFERENCES asset(id) NOT NULL,
value TEXT,
UNIQUE (name, asset_id, timestamp)
);
SELECT create_hypertable('tag_string', 'timestamp', if_not_exists => TRUE);;
CREATE INDEX IF NOT EXISTS ON tag_string (asset_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS ON tag_string (name);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE OR REPLACE FUNCTION get_asset_id(
_enterprise text,
_site text DEFAULT '',
_area text DEFAULT '',
_line text DEFAULT '',
_workcell text DEFAULT '',
_origin_id text DEFAULT ''
)
RETURNS integer AS '
DECLARE
result_id integer;
BEGIN
SELECT id INTO result_id FROM asset
WHERE enterprise = _enterprise
AND site = _site
AND area = _area
AND line = _line
AND workcell = _workcell
AND origin_id = _origin_id
LIMIT 1; -- Ensure only one id is returned
RETURN result_id;
END;
' LANGUAGE plpgsql;
GRANT EXECUTE ON FUNCTION umh_v2.public.get_asset_id(text, text, text, text, text, text) TO grafanareader;
-- $$
CREATE OR REPLACE FUNCTION get_asset_ids(
_enterprise text,
_site text DEFAULT '',
_area text DEFAULT '',
_line text DEFAULT '',
_workcell text DEFAULT '',
_origin_id text DEFAULT ''
)
RETURNS SETOF integer AS '
BEGIN
RETURN QUERY
SELECT id FROM asset
WHERE enterprise = _enterprise
AND (_site = '''' OR site = _site)
AND (_area = '''' OR area = _area)
AND (_line = '''' OR line = _line)
AND (_workcell = '''' OR workcell = _workcell)
AND (_origin_id = '''' OR origin_id = _origin_id);
END;
' LANGUAGE plpgsql;
GRANT EXECUTE ON FUNCTION umh_v2.public.get_asset_ids(text, text, text, text, text, text) TO grafanareader;
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE TABLE IF NOT EXISTS product_type (
product_type_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
external_product_type_id TEXT NOT NULL,
cycle_time_ms INTEGER NOT NULL,
asset_id INTEGER REFERENCES asset(id),
CONSTRAINT external_product_asset_uniq UNIQUE (external_product_type_id, asset_id),
CHECK (cycle_time_ms > 0)
);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE EXTENSION IF NOT EXISTS btree_gist;
-- This table stores information about manufacturing orders. The ISA-95 model defines work orders in terms of production requests.
-- Here, each work order is linked to a specific asset and product type
CREATE TABLE IF NOT EXISTS work_order (
work_order_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
external_work_order_id TEXT NOT NULL,
asset_id INTEGER NOT NULL REFERENCES asset(id),
product_type_id INTEGER NOT NULL REFERENCES product_type(product_type_id),
quantity INTEGER NOT NULL,
status INTEGER NOT NULL DEFAULT 0, -- 0: planned, 1: in progress, 2: completed
start_time TIMESTAMPTZ,
end_time TIMESTAMPTZ,
CONSTRAINT asset_workorder_uniq UNIQUE (asset_id, external_work_order_id),
CHECK (quantity > 0),
CHECK (status BETWEEN 0 AND 2),
UNIQUE (asset_id, start_time),
EXCLUDE USING gist (asset_id WITH =, tstzrange(start_time, end_time) WITH &&) WHERE (start_time IS NOT NULL AND end_time IS NOT NULL)
);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
CREATE TABLE IF NOT EXISTS product (
product_type_id INTEGER REFERENCES product_type(product_type_id),
product_batch_id TEXT,
asset_id INTEGER REFERENCES asset(id),
start_time TIMESTAMPTZ,
end_time TIMESTAMPTZ NOT NULL,
quantity INTEGER NOT NULL,
bad_quantity INTEGER DEFAULT 0,
CHECK (quantity > 0),
CHECK (bad_quantity >= 0),
CHECK (bad_quantity <= quantity),
CHECK (start_time <= end_time),
UNIQUE (asset_id, end_time, product_batch_id)
);
-- creating hypertable
SELECT create_hypertable('product', 'end_time', if_not_exists => TRUE);;
-- creating an index to increase performance
CREATE INDEX IF NOT EXISTS idx_products_asset_end_time ON product(asset_id, end_time DESC);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
-- Manages work shifts for assets. Shift scheduling is a key operational aspect under ISA-95, impacting resource planning and allocation.
CREATE TABLE IF NOT EXISTS shift (
shift_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
asset_id INTEGER REFERENCES asset(id),
start_time TIMESTAMPTZ NOT NULL,
end_time TIMESTAMPTZ NOT NULL,
CONSTRAINT shift_start_asset_uniq UNIQUE (start_time, asset_id),
CHECK (start_time < end_time),
EXCLUDE USING gist (asset_id WITH =, tstzrange(start_time, end_time) WITH &&)
);
EOF
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
-- Records the state changes of assets over time. State tracking supports ISA-95's goal of detailed monitoring and control of manufacturing operations.
-- State Table
-- It assumes that a state continues until a new state is recorded.
CREATE TABLE IF NOT EXISTS state (
asset_id INTEGER REFERENCES asset(id),
start_time TIMESTAMPTZ NOT NULL,
state INT NOT NULL,
CHECK (state >= 0),
UNIQUE (start_time, asset_id)
);
-- creating hypertable
SELECT create_hypertable('state', 'start_time', if_not_exists => TRUE);;
-- creating an index to increase performance
CREATE INDEX IF NOT EXISTS idx_states_asset_start_time ON state(asset_id, start_time DESC);
EOF
# Fix owners
sudo $(which kubectl) exec -it united-manufacturing-hub-timescaledb-0 -c timescaledb --kubeconfig /etc/rancher/k3s/k3s.yaml -n united-manufacturing-hub -- psql -U postgres -d umh_v2 <<EOF
ALTER TABLE asset OWNER TO kafkatopostgresqlv2;
ALTER TABLE tag OWNER TO kafkatopostgresqlv2;
ALTER TABLE tag_string OWNER TO kafkatopostgresqlv2;
ALTER TABLE work_order OWNER TO kafkatopostgresqlv2;
ALTER TABLE product_type OWNER TO kafkatopostgresqlv2;
ALTER TABLE product OWNER TO kafkatopostgresqlv2;
ALTER TABLE shift OWNER TO kafkatopostgresqlv2;
ALTER TABLE state OWNER TO kafkatopostgresqlv2;
GRANT SELECT ON umh_v2.public.asset TO grafanareader;
GRANT SELECT ON umh_v2.public.tag TO grafanareader;
GRANT SELECT ON umh_v2.public.tag_string TO grafanareader;
GRANT SELECT ON umh_v2.public.work_order TO grafanareader;
GRANT SELECT ON umh_v2.public.product_type TO grafanareader;
GRANT SELECT ON umh_v2.public.product TO grafanareader;
GRANT SELECT ON umh_v2.public.shift TO grafanareader;
GRANT SELECT ON umh_v2.public.state TO grafanareader;
EOF
```


## Troubleshooting

If for some reason the upgrade fails, you can delete the deployment and statefulsets and try again:
This will _not_ delete your data.

```bash
sudo $(which kubectl) -n united-manufacturing-hub --kubeconfig /etc/rancher/k3s/k3s.yaml delete deployment \
united-manufacturing-hub-factoryinsight-deployment \
united-manufacturing-hub-iotsensorsmqtt \
united-manufacturing-hub-opcuasimulator-deployment \
united-manufacturing-hub-packmlmqttsimulator \
united-manufacturing-hub-mqttkafkabridge \
united-manufacturing-hub-kafkatopostgresqlv2 \
united-manufacturing-hub-kafkatopostgresql \
united-manufacturing-hub-grafana \
united-manufacturing-hub-databridge-0 \
united-manufacturing-hub-console

sudo $(which kubectl) -n united-manufacturing-hub --kubeconfig /etc/rancher/k3s/k3s.yaml delete statefulset \
united-manufacturing-hub-hivemqce \
united-manufacturing-hub-kafka \
united-manufacturing-hub-nodered \
united-manufacturing-hub-sensorconnect \
united-manufacturing-hub-mqttbridge \
united-manufacturing-hub-timescaledb \
united-manufacturing-hub-redis-master

sudo $(which kubectl) -n united-manufacturing-hub --kubeconfig /etc/rancher/k3s/k3s.yaml delete jobs \
united-manufacturing-hub-kafka-configuration
```